<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticated Music Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
        }
        input, select {
            background: #3a3a3a;
            color: white;
            width: 200px;
        }
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .song-list {
            margin-top: 20px;
        }
        .song-item {
            background: #3a3a3a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .song-content {
            flex-grow: 1;
        }
        .song-actions {
            display: flex;
            gap: 5px;
        }
        .edit-form {
            background: #4a4a4a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .edit-form input {
            width: 250px;
            margin: 5px 10px 5px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .user-info {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .table-list {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .table-item {
            background: #4a4a4a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Authenticated Music Library</h1>

    <!-- Login Form -->
    <div id="loginForm" class="container">
        <h3>Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button onclick="login()">Login</button>
        <div id="loginStatus"></div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- User Info -->
        <div class="user-info">
            <span id="userEmail"></span>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- Table Management -->
        <div class="container">
            <h3>Table Management</h3>
            <div class="table-selector">
                <select id="tableSelect" onchange="switchTable()">
                    <option value="">Select a table...</option>
                </select>
                <input type="text" id="newTableName" placeholder="New table name" />
                <button onclick="createTable()">Create Table</button>
            </div>
            
            <div class="table-list">
                <h4>Your Tables:</h4>
                <div id="tablesList"></div>
            </div>
        </div>

        <!-- Song Management -->
        <div id="songManagement" class="container hidden">
            <h3>Manage Songs in: <span id="currentTableName"></span></h3>
            <input type="text" id="songname" placeholder="Song Name" />
            <input type="text" id="songauthor" placeholder="Song Author" />
            <input type="text" id="songurl" placeholder="YouTube URL" />
            <button onclick="addSong()">Add Song</button>
            <button class="danger" onclick="deleteTable()">Delete This Table</button>
        </div>

        <div id="status"></div>
        <div id="songs" class="song-list"></div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://cwhxanbpymkngzpbsshh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aHhhbmJweW1rbmd6cGJzc2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTQzMTksImV4cCI6MjA2OTQzMDMxOX0.6K3eM1XoWaPmyMHsLYgw0mAnSxYjME4clflL4PxQalQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentTable = null;

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }

        function showLoginStatus(message, isError = false) {
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                showLoginStatus('Please enter email and password', true);
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                currentUser = data.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                showStatus('Logged in successfully!');
                loadTables();

            } catch (error) {
                console.error('Login error:', error);
                showLoginStatus('Login failed: ' + error.message, true);
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                currentTable = null;
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('songManagement').classList.add('hidden');
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showLoginStatus('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadTables() {
            try {
                const { data, error } = await supabase
                    .from('music_tables')
                    .select('*')
                    .eq('owner_id', currentUser.id);

                if (error) throw error;

                const tableSelect = document.getElementById('tableSelect');
                const tablesList = document.getElementById('tablesList');
                
                // Clear and populate select
                tableSelect.innerHTML = '<option value="">Select a table...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.table_name;
                        option.textContent = table.table_name;
                        tableSelect.appendChild(option);
                    });

                    // Display tables list
                    tablesList.innerHTML = data.map(table => `
                        <div class="table-item">
                            <span><strong>${table.table_name}</strong> (Created: ${new Date(table.created_at).toLocaleDateString()})</span>
                            <button class="danger" onclick="deleteTableFromList('${table.table_name}')">Delete</button>
                        </div>
                    `).join('');
                } else {
                    tablesList.innerHTML = '<p>No tables created yet. Create your first table above!</p>';
                }

            } catch (error) {
                console.error('Error loading tables:', error);
                showStatus('Error loading tables: ' + error.message, true);
            }
        }

        async function createTable() {
            const tableName = document.getElementById('newTableName').value.trim();
            
            if (!tableName) {
                showStatus('Please enter a table name', true);
                return;
            }

            // Validate table name (alphanumeric and underscores only)
            if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(tableName)) {
                showStatus('Table name must start with a letter and contain only letters, numbers, and underscores', true);
                return;
            }

            try {
                // First, register the table in our music_tables registry
                const { error: registryError } = await supabase
                    .from('music_tables')
                    .insert([{
                        table_name: tableName,
                        owner_id: currentUser.id
                    }]);

                if (registryError) throw registryError;

                // Create the actual songs table using RPC function
                const { error: createError } = await supabase.rpc('create_music_table', {
                    table_name: tableName
                });

                if (createError) throw createError;

                showStatus('Table created successfully!');
                document.getElementById('newTableName').value = '';
                loadTables();

            } catch (error) {
                console.error('Error creating table:', error);
                showStatus('Error creating table: ' + error.message, true);
            }
        }

        async function switchTable() {
            const tableName = document.getElementById('tableSelect').value;
            
            if (!tableName) {
                document.getElementById('songManagement').classList.add('hidden');
                return;
            }

            currentTable = tableName;
            document.getElementById('currentTableName').textContent = tableName;
            document.getElementById('songManagement').classList.remove('hidden');
            loadSongs();
        }

        async function addSong() {
            const songname = document.getElementById('songname').value.trim();
            const songauthor = document.getElementById('songauthor').value.trim();
            const songurl = document.getElementById('songurl').value.trim();

            if (!songname || !songurl || !currentTable) {
                showStatus('Please enter song name and URL', true);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .insert([{
                        songname: songname,
                        songauthor: songauthor,
                        songurl: songurl
                    }]);

                if (error) throw error;

                showStatus('Song added successfully!');
                document.getElementById('songname').value = '';
                document.getElementById('songauthor').value = '';
                document.getElementById('songurl').value = '';
                
                loadSongs();

            } catch (error) {
                console.error('Error adding song:', error);
                showStatus('Error adding song: ' + error.message, true);
            }
        }

        async function loadSongs() {
            if (!currentTable) return;

            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .select('*');

                if (error) throw error;

                const songsDiv = document.getElementById('songs');
                if (data && data.length > 0) {
                    songsDiv.innerHTML = '<h3>Songs in ' + currentTable + ':</h3>' + 
                        data.map(song => `
                            <div class="song-item" id="song-${song.id}">
                                <div class="song-content">
                                    <strong>${song.songname}</strong> 
                                    ${song.songauthor ? `by ${song.songauthor}` : ''}
                                    <br>
                                    <small><a href="${song.songurl}" target="_blank" style="color: #4CAF50;">${song.songurl}</a></small>
                                </div>
                                <div class="song-actions">
                                    <button onclick="showEditForm(${song.id}, '${song.songname.replace(/'/g, "\\'")}', '${(song.songauthor || '').replace(/'/g, "\\'")}', '${song.songurl.replace(/'/g, "\\'")}')">Edit</button>
                                    <button class="danger" onclick="deleteSong(${song.id})">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    
                    showStatus(`Loaded ${data.length} songs from ${currentTable}`);
                } else {
                    songsDiv.innerHTML = `<p>No songs found in ${currentTable}</p>`;
                    showStatus('No songs in this table');
                }

            } catch (error) {
                console.error('Error loading songs:', error);
                showStatus('Error loading songs: ' + error.message, true);
            }
        }

        async function deleteSong(songId) {
            if (!confirm('Are you sure you want to delete this song?')) return;

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .eq('id', songId);

                if (error) throw error;

                showStatus('Song deleted successfully!');
                loadSongs();

            } catch (error) {
                console.error('Error deleting song:', error);
                showStatus('Error deleting song: ' + error.message, true);
            }
        }

        function showEditForm(songId, songname, songauthor, songurl) {
            // Hide all other edit forms first
            document.querySelectorAll('.edit-form').forEach(form => form.remove());
            
            const songElement = document.getElementById(`song-${songId}`);
            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            editForm.innerHTML = `
                <h4>Edit Song</h4>
                <input type="text" id="edit-songname-${songId}" value="${songname}" placeholder="Song Name" />
                <input type="text" id="edit-songauthor-${songId}" value="${songauthor}" placeholder="Song Author" />
                <input type="text" id="edit-songurl-${songId}" value="${songurl}" placeholder="YouTube URL" />
                <button onclick="updateSong(${songId})">Save Changes</button>
                <button onclick="cancelEdit(${songId})">Cancel</button>
            `;
            
            songElement.insertAdjacentElement('afterend', editForm);
        }

        function cancelEdit(songId) {
            document.querySelectorAll('.edit-form').forEach(form => form.remove());
        }

        async function updateSong(songId) {
            const songname = document.getElementById(`edit-songname-${songId}`).value.trim();
            const songauthor = document.getElementById(`edit-songauthor-${songId}`).value.trim();
            const songurl = document.getElementById(`edit-songurl-${songId}`).value.trim();

            if (!songname || !songurl) {
                showStatus('Please enter song name and URL', true);
                return;
            }

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .update({
                        songname: songname,
                        songauthor: songauthor,
                        songurl: songurl
                    })
                    .eq('id', songId);

                if (error) throw error;

                showStatus('Song updated successfully!');
                document.querySelectorAll('.edit-form').forEach(form => form.remove());
                loadSongs();

            } catch (error) {
                console.error('Error updating song:', error);
                showStatus('Error updating song: ' + error.message, true);
            }
        }

        async function deleteTable() {
            if (!currentTable) return;
            
            if (!confirm(`Are you sure you want to delete the entire table "${currentTable}" and all its songs?`)) return;

            try {
                // Remove from registry first
                const { error: registryError } = await supabase
                    .from('music_tables')
                    .delete()
                    .eq('table_name', currentTable)
                    .eq('owner_id', currentUser.id);

                if (registryError) throw registryError;

                // Drop the actual table using RPC function
                const { error: dropError } = await supabase.rpc('drop_music_table', {
                    table_name: currentTable
                });

                if (dropError) throw dropError;

                showStatus('Table deleted successfully!');
                currentTable = null;
                document.getElementById('songManagement').classList.add('hidden');
                document.getElementById('songs').innerHTML = '';
                loadTables();

            } catch (error) {
                console.error('Error deleting table:', error);
                showStatus('Error deleting table: ' + error.message, true);
            }
        }

        async function deleteTableFromList(tableName) {
            if (!confirm(`Are you sure you want to delete the table "${tableName}" and all its songs?`)) return;

            try {
                // Remove from registry first
                const { error: registryError } = await supabase
                    .from('music_tables')
                    .delete()
                    .eq('table_name', tableName)
                    .eq('owner_id', currentUser.id);

                if (registryError) throw registryError;

                // Drop the actual table using RPC function
                const { error: dropError } = await supabase.rpc('drop_music_table', {
                    table_name: tableName
                });

                if (dropError) throw dropError;

                showStatus('Table deleted successfully!');
                
                // If we deleted the currently selected table, hide song management
                if (currentTable === tableName) {
                    currentTable = null;
                    document.getElementById('songManagement').classList.add('hidden');
                    document.getElementById('songs').innerHTML = '';
                }
                
                loadTables();

            } catch (error) {
                console.error('Error deleting table:', error);
                showStatus('Error deleting table: ' + error.message, true);
            }
        }

        // Check for existing session on page load
        window.onload = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadTables();
            }
        };

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentTable = null;
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('songManagement').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
