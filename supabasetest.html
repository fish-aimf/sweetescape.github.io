<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticated Music Library</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .hidden { display: none; }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
        }
        input, select {
            background: #3a3a3a;
            color: white;
            width: 200px;
        }
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
        .song-list {
            margin-top: 20px;
        }
        .song-item {
            background: #3a3a3a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .song-content {
            flex-grow: 1;
        }
        .song-actions {
            display: flex;
            gap: 5px;
        }
        .edit-form {
            background: #4a4a4a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .edit-form input {
            width: 250px;
            margin: 5px 10px 5px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #4CAF50; }
        .error { background: #f44336; }
        .user-info {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .table-list {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .table-item {
            background: #4a4a4a;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Authenticated Music Library</h1>

    <!-- Login Form -->
    <div id="loginForm" class="container">
        <h3>Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <button onclick="login()">Login</button>
        <div id="loginStatus"></div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- User Info -->
        <div class="user-info">
            <span id="userEmail"></span>
            <button onclick="logout()">Logout</button>
        </div>

        <!-- Table Management -->
        <div class="container">
            <h3>Table Management</h3>
            <div class="table-selector">
                <select id="tableSelect" onchange="switchTable()">
                    <option value="">Select a table...</option>
                </select>
                <input type="text" id="newTableName" placeholder="New table name" />
                <button onclick="createTable()">Create Table</button>
            </div>
            
            <div class="table-list">
                <h4>Your Tables:</h4>
                <div id="tablesList"></div>
            </div>
        </div>

        <!-- Song Management -->
        <div id="songManagement" class="container hidden">
            <h3>Manage Songs in: <span id="currentTableName"></span></h3>
            <input type="text" id="songname" placeholder="Song Name" />
            <input type="text" id="songauthor" placeholder="Song Author" />
            <input type="text" id="songurl" placeholder="YouTube URL" />
            <button onclick="addSong()">Add Song</button>
            <button class="danger" onclick="deleteTable()">Delete This Table</button>
        </div>

        <div id="status"></div>
        <div id="songs" class="song-list"></div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://cwhxanbpymkngzpbsshh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3aHhhbmJweW1rbmd6cGJzc2hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4NTQzMTksImV4cCI6MjA2OTQzMDMxOX0.6K3eM1XoWaPmyMHsLYgw0mAnSxYjME4clflL4PxQalQ';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentTable = null;
        let isAdmin = false;
let adminViewMode = false;

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }

        function showLoginStatus(message, isError = false) {
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 3000);
        }
        async function checkAdminStatus() {
    try {
        const { data, error } = await supabase
            .from('profiles')
            .select('is_admin')
            .eq('id', currentUser.id)
            .single();

        if (error) {
            await supabase.from('profiles').insert([{
                id: currentUser.id,
                email: currentUser.email,
                is_admin: false
            }]);
            isAdmin = false;
        } else {
            isAdmin = data.is_admin || false;
        }

        // Show/hide admin elements
        document.getElementById('adminBadge').classList.toggle('hidden', !isAdmin);
        document.getElementById('adminPanel').classList.toggle('hidden', !isAdmin);
        document.getElementById('editDescBtn').classList.toggle('hidden', !isAdmin);
    } catch (error) {
        console.error('Error checking admin status:', error);
        isAdmin = false;
    }
}

        async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!email || !password) {
        showLoginStatus('Please enter email and password', true);
        return;
    }

    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        currentUser = data.user;
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        await checkAdminStatus();
        showStatus('Logged in successfully!');
        loadTables();
    } catch (error) {
        console.error('Login error:', error);
        showLoginStatus('Login failed: ' + error.message, true);
    }
}
        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                currentTable = null;
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('songManagement').classList.add('hidden');
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showLoginStatus('Logged out successfully!');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadTables() {
    try {
        let query = supabase.from('music_tables').select('*');
        if (!adminViewMode) {
            query = query.eq('owner_id', currentUser.id);
        }

        const { data, error } = await query;
        if (error) throw error;

        const tableSelect = document.getElementById('tableSelect');
        const tablesList = document.getElementById('tablesList');
        
        tableSelect.innerHTML = '<option value="">Select a table...</option>';
        
        if (data && data.length > 0) {
            data.forEach(table => {
                const option = document.createElement('option');
                option.value = table.table_name;
                option.textContent = `${table.table_name}${adminViewMode && table.owner_id !== currentUser.id ? ' (Not yours)' : ''}`;
                tableSelect.appendChild(option);
            });

            tablesList.innerHTML = data.map(table => {
                const isOwner = table.owner_id === currentUser.id;
                const canEdit = isOwner || isAdmin;
                
                return `
                    <div class="table-item">
                        <div class="table-info">
                            <div><strong>${table.table_name}</strong> 
                                ${adminViewMode && !isOwner ? '<span class="owner-info">(Not yours)</span>' : ''}
                            </div>
                            ${table.description ? `<div class="table-description">${table.description}</div>` : ''}
                            <div class="owner-info">Created: ${new Date(table.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="table-actions">
                            ${canEdit ? `<button class="danger" onclick="deleteTableFromList('${table.table_name}')">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            tablesList.innerHTML = '<p>No tables found. Create your first table above!</p>';
        }
    } catch (error) {
        console.error('Error loading tables:', error);
        showStatus('Error loading tables: ' + error.message, true);
    }
}

        async function createTable() {
    const tableName = document.getElementById('newTableName').value.trim();
    const tableDescription = document.getElementById('newTableDescription').value.trim();
    
    if (!tableName) {
        showStatus('Please enter a table name', true);
        return;
    }

    if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(tableName)) {
        showStatus('Table name must start with a letter and contain only letters, numbers, and underscores', true);
        return;
    }

    try {
        const { error: registryError } = await supabase
            .from('music_tables')
            .insert([{
                table_name: tableName,
                owner_id: currentUser.id,
                description: tableDescription || null
            }]);

        if (registryError) throw registryError;

        const { error: createError } = await supabase.rpc('create_music_table', {
            table_name: tableName
        });

        if (createError) throw createError;

        showStatus('Table created successfully!');
        document.getElementById('newTableName').value = '';
        document.getElementById('newTableDescription').value = '';
        loadTables();
    } catch (error) {
        console.error('Error creating table:', error);
        showStatus('Error creating table: ' + error.message, true);
    }
}
        async function switchTable() {
            const tableName = document.getElementById('tableSelect').value;
            
            if (!tableName) {
                document.getElementById('songManagement').classList.add('hidden');
                return;
            }

            currentTable = tableName;
            document.getElementById('currentTableName').textContent = tableName;
            document.getElementById('songManagement').classList.remove('hidden');
            loadSongs();
        }

        async function addSong() {
            const songname = document.getElementById('songname').value.trim();
            const songauthor = document.getElementById('songauthor').value.trim();
            const songurl = document.getElementById('songurl').value.trim();

            if (!songname || !songurl || !currentTable) {
                showStatus('Please enter song name and URL', true);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .insert([{
                        songname: songname,
                        songauthor: songauthor,
                        songurl: songurl
                    }]);

                if (error) throw error;

                showStatus('Song added successfully!');
                document.getElementById('songname').value = '';
                document.getElementById('songauthor').value = '';
                document.getElementById('songurl').value = '';
                
                loadSongs();

            } catch (error) {
                console.error('Error adding song:', error);
                showStatus('Error adding song: ' + error.message, true);
            }
        }

        async function loadSongs() {
            if (!currentTable) return;

            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .select('*');

                if (error) throw error;

                const songsDiv = document.getElementById('songs');
                if (data && data.length > 0) {
                    songsDiv.innerHTML = '<h3>Songs in ' + currentTable + ':</h3>' + 
                        data.map(song => `
                            <div class="song-item" id="song-${song.id}">
                                <div class="song-content">
                                    <strong>${song.songname}</strong> 
                                    ${song.songauthor ? `by ${song.songauthor}` : ''}
                                    <br>
                                    <small><a href="${song.songurl}" target="_blank" style="color: #4CAF50;">${song.songurl}</a></small>
                                </div>
                                <div class="song-actions">
                                    <button onclick="showEditForm(${song.id}, '${song.songname.replace(/'/g, "\\'")}', '${(song.songauthor || '').replace(/'/g, "\\'")}', '${song.songurl.replace(/'/g, "\\'")}')">Edit</button>
                                    <button class="danger" onclick="deleteSong(${song.id})">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    
                    showStatus(`Loaded ${data.length} songs from ${currentTable}`);
                } else {
                    songsDiv.innerHTML = `<p>No songs found in ${currentTable}</p>`;
                    showStatus('No songs in this table');
                }

            } catch (error) {
                console.error('Error loading songs:', error);
                showStatus('Error loading songs: ' + error.message, true);
            }
        }

        async function deleteSong(songId) {
            if (!confirm('Are you sure you want to delete this song?')) return;

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .eq('id', songId);

                if (error) throw error;

                showStatus('Song deleted successfully!');
                loadSongs();

            } catch (error) {
                console.error('Error deleting song:', error);
                showStatus('Error deleting song: ' + error.message, true);
            }
        }

        function showEditForm(songId, songname, songauthor, songurl) {
            // Hide all other edit forms first
            document.querySelectorAll('.edit-form').forEach(form => form.remove());
            
            const songElement = document.getElementById(`song-${songId}`);
            const editForm = document.createElement('div');
            editForm.className = 'edit-form';
            editForm.innerHTML = `
                <h4>Edit Song</h4>
                <input type="text" id="edit-songname-${songId}" value="${songname}" placeholder="Song Name" />
                <input type="text" id="edit-songauthor-${songId}" value="${songauthor}" placeholder="Song Author" />
                <input type="text" id="edit-songurl-${songId}" value="${songurl}" placeholder="YouTube URL" />
                <button onclick="updateSong(${songId})">Save Changes</button>
                <button onclick="cancelEdit(${songId})">Cancel</button>
            `;
            
            songElement.insertAdjacentElement('afterend', editForm);
        }

        function cancelEdit(songId) {
            document.querySelectorAll('.edit-form').forEach(form => form.remove());
        }

        async function updateSong(songId) {
            const songname = document.getElementById(`edit-songname-${songId}`).value.trim();
            const songauthor = document.getElementById(`edit-songauthor-${songId}`).value.trim();
            const songurl = document.getElementById(`edit-songurl-${songId}`).value.trim();

            if (!songname || !songurl) {
                showStatus('Please enter song name and URL', true);
                return;
            }

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .update({
                        songname: songname,
                        songauthor: songauthor,
                        songurl: songurl
                    })
                    .eq('id', songId);

                if (error) throw error;

                showStatus('Song updated successfully!');
                document.querySelectorAll('.edit-form').forEach(form => form.remove());
                loadSongs();

            } catch (error) {
                console.error('Error updating song:', error);
                showStatus('Error updating song: ' + error.message, true);
            }
        }

        async function deleteTable() {
            if (!currentTable) return;
            
            if (!confirm(`Are you sure you want to delete the entire table "${currentTable}" and all its songs?`)) return;

            try {
                // Remove from registry first
                const { error: registryError } = await supabase
                    .from('music_tables')
                    .delete()
                    .eq('table_name', currentTable)
                    .eq('owner_id', currentUser.id);

                if (registryError) throw registryError;

                // Drop the actual table using RPC function
                const { error: dropError } = await supabase.rpc('drop_music_table', {
                    table_name: currentTable
                });

                if (dropError) throw dropError;

                showStatus('Table deleted successfully!');
                currentTable = null;
                document.getElementById('songManagement').classList.add('hidden');
                document.getElementById('songs').innerHTML = '';
                loadTables();

            } catch (error) {
                console.error('Error deleting table:', error);
                showStatus('Error deleting table: ' + error.message, true);
            }
        }

        async function deleteTableFromList(tableName) {
            if (!confirm(`Are you sure you want to delete the table "${tableName}" and all its songs?`)) return;

            try {
                // Remove from registry first
                const { error: registryError } = await supabase
                    .from('music_tables')
                    .delete()
                    .eq('table_name', tableName)
                    .eq('owner_id', currentUser.id);

                if (registryError) throw registryError;

                // Drop the actual table using RPC function
                const { error: dropError } = await supabase.rpc('drop_music_table', {
                    table_name: tableName
                });

                if (dropError) throw dropError;

                showStatus('Table deleted successfully!');
                
                // If we deleted the currently selected table, hide song management
                if (currentTable === tableName) {
                    currentTable = null;
                    document.getElementById('songManagement').classList.add('hidden');
                    document.getElementById('songs').innerHTML = '';
                }
                
                loadTables();

            } catch (error) {
                console.error('Error deleting table:', error);
                showStatus('Error deleting table: ' + error.message, true);
            }
        }
        async function loadAllTables() {
    if (!isAdmin) {
        showStatus('Admin privileges required', true);
        return;
    }

    try {
        const { data, error } = await supabase.rpc('get_all_tables');
        if (error) throw error;

        const adminTablesList = document.getElementById('adminTablesList');
        
        if (data && data.length > 0) {
            adminTablesList.innerHTML = '<h4>All Tables in System:</h4>' + 
                data.map(table => `
                    <div class="table-item">
                        <div class="table-info">
                            <div><strong>${table.table_name}</strong></div>
                            ${table.description ? `<div class="table-description">${table.description}</div>` : ''}
                            <div class="owner-info">Owner: ${table.owner_email || 'Unknown'}</div>
                            <div class="owner-info">Created: ${new Date(table.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="table-actions">
                            <button onclick="switchToTable('${table.table_name}')">Manage</button>
                            <button class="danger" onclick="deleteTableFromList('${table.table_name}')">Delete</button>
                        </div>
                    </div>
                `).join('');
        } else {
            adminTablesList.innerHTML = '<p>No tables found in the system.</p>';
        }
    } catch (error) {
        console.error('Error loading all tables:', error);
        showStatus('Error loading all tables: ' + error.message, true);
    }
}

function toggleAdminTableView() {
    if (!isAdmin) {
        showStatus('Admin privileges required', true);
        return;
    }
    
    adminViewMode = !adminViewMode;
    loadTables();
    showStatus(adminViewMode ? 'Switched to admin view (all tables)' : 'Switched to user view (your tables)');
}

async function editTableDescription() {
    if (!currentTable) return;

    try {
        const { data, error } = await supabase
            .from('music_tables')
            .select('description')
            .eq('table_name', currentTable)
            .single();

        if (error) throw error;

        const newDescription = prompt('Enter new description:', data.description || '');
        if (newDescription === null) return;

        const { error: updateError } = await supabase
            .from('music_tables')
            .update({ description: newDescription || null })
            .eq('table_name', currentTable);

        if (updateError) throw updateError;

        showStatus('Table description updated successfully!');
        switchTable();
        loadTables();
    } catch (error) {
        console.error('Error updating table description:', error);
        showStatus('Error updating table description: ' + error.message, true);
    }
}

        // Check for existing session on page load
        window.onload = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                document.getElementById('userEmail').textContent = currentUser.email;
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadTables();
            }
        };

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentTable = null;
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('songManagement').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
